<div class="dashboard">
  <header class="dashboard-header">
    <h1>Tableau de bord</h1>
    <button class="btn btn-outline" (click)="logout()">Déconnexion</button>
  </header>

  <div class="tabs">
    <button class="tab" [class.active]="activeTab() === 'products'" (click)="switchTab('products')">Produits</button>
    <button class="tab" [class.active]="activeTab() === 'orders'" (click)="switchTab('orders')">Commandes</button>
  </div>

  @if (errorMsg()) {
    <div class="error-banner">{{ errorMsg() }}</div>
  }

  <!-- PRODUCTS TAB -->
  @if (activeTab() === 'products') {
    <div class="tab-content">
      <div class="tab-header">
        <h2>Produits ({{ products().length }})</h2>
        <button class="btn btn-primary" (click)="openNewProduct()">+ Nouveau produit</button>
      </div>

      @if (loading()) {
        <p class="loading">Chargement...</p>
      }

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Image</th>
              <th>Nom</th>
              <th>Prix</th>
              <th>Actif</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (product of products(); track product.id) {
              <tr>
                <td>
                  @if (product.image_url) {
                    <img [src]="product.image_url" [alt]="product.name" class="thumb" />
                  } @else {
                    <span class="no-image">--</span>
                  }
                </td>
                <td>
                  <strong>{{ product.name }}</strong>
                  @if (product.description) {
                    <br /><small>{{ product.description }}</small>
                  }
                </td>
                <td>{{ formatPrice(product.price_cents) }}</td>
                <td>
                  <button class="badge" [class.active]="product.is_active" (click)="toggleActive(product)">
                    {{ product.is_active ? 'Actif' : 'Inactif' }}
                  </button>
                </td>
                <td class="actions">
                  <button class="btn btn-sm" (click)="openEditProduct(product)">Modifier</button>
                  <button class="btn btn-sm btn-danger" (click)="deleteProduct(product)">Supprimer</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- ORDERS TAB -->
  @if (activeTab() === 'orders') {
    <div class="tab-content">
      <div class="tab-header">
        <h2>Commandes ({{ orders().length }})</h2>
        <button class="btn btn-outline" (click)="loadOrders()">Rafraîchir</button>
      </div>

      @if (loading()) {
        <p class="loading">Chargement...</p>
      }

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Classe</th>
              <th>Produit</th>
              <th>Qté</th>
              <th>Total</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            @for (order of orders(); track order.id) {
              <tr>
                <td>{{ order.created_at | date: 'dd/MM/yyyy HH:mm' }}</td>
                <td>
                  {{ order.customer_name }}
                  <br /><small>{{ order.customer_email }}</small>
                </td>
                <td>{{ order.child_class }}</td>
                <td>{{ order.product_name }}</td>
                <td>{{ order.quantity }}</td>
                <td>{{ formatPrice(order.total_cents) }}</td>
                <td>
                  <span class="badge-status" [class]="order.payment_status">
                    {{ order.payment_status === 'paid' ? 'Payé' : order.payment_status === 'pending' ? 'En attente' : 'Annulé' }}
                  </span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      @if (orders().length === 0 && !loading()) {
        <p class="empty-message">Aucune commande pour le moment.</p>
      }
    </div>
  }
</div>

<!-- PRODUCT FORM MODAL -->
@if (showProductForm()) {
  <div class="modal-overlay" (click)="closeProductForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeProductForm()">✕</button>
      <h2>{{ editingProduct() ? 'Modifier le produit' : 'Nouveau produit' }}</h2>

      <form (ngSubmit)="saveProduct()">
        <div class="form-group">
          <label for="p_name">Nom</label>
          <input id="p_name" type="text" [(ngModel)]="productForm.name" name="name" required />
        </div>

        <div class="form-group">
          <label for="p_desc">Description</label>
          <textarea id="p_desc" [(ngModel)]="productForm.description" name="description" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="p_price">Prix (en centimes, ex: 1500 = 15,00 €)</label>
          <input id="p_price" type="number" [(ngModel)]="productForm.price_cents" name="price_cents" min="1" required />
        </div>

        <div class="form-group">
          <label for="p_image">Image</label>
          <input id="p_image" type="file" accept="image/jpeg,image/png,image/webp" (change)="onImageSelected($event)" />
          @if (uploadingImage()) {
            <small>Upload en cours...</small>
          }
          @if (productForm.image_url) {
            <img [src]="productForm.image_url" alt="Aperçu" class="image-preview" />
          }
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" [(ngModel)]="productForm.is_active" name="is_active" />
            Produit actif (visible sur le site)
          </label>
        </div>

        <button class="btn btn-primary btn-full" type="submit" [disabled]="savingProduct() || uploadingImage()">
          {{ savingProduct() ? 'Enregistrement...' : 'Enregistrer' }}
        </button>
      </form>
    </div>
  </div>
}
